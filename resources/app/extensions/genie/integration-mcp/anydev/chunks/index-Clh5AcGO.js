function getDefault(e,t,r){return"function"==typeof e.default?e.default(t,r):e.default}function addError(e,t){return e?(e.push(t),e):[t]}function handleError(e,t){switch(t?.errorMode){case"ignore":break;case"warn":console.warn(e);break;default:throw Error(e)}}function convertAction(e,t,r){if(r?.ignoreActions?.includes(t.type))return e;let a;switch(t.type){case"base64":e.contentEncoding="base64";break;case"bic":case"cuid2":case"decimal":case"digits":case"emoji":case"hexadecimal":case"hex_color":case"nanoid":case"octal":case"ulid":e.pattern=t.requirement.source;break;case"description":e.description=t.description;break;case"email":e.format="email";break;case"empty":"array"===e.type?e.maxItems=0:("string"!==e.type&&(a=addError(a,`The "${t.type}" action is not supported on type "${e.type}".`)),e.maxLength=0);break;case"entries":e.minProperties=t.requirement,e.maxProperties=t.requirement;break;case"integer":e.type="integer";break;case"ipv4":e.format="ipv4";break;case"ipv6":e.format="ipv6";break;case"iso_date":e.format="date";break;case"iso_date_time":case"iso_timestamp":e.format="date-time";break;case"iso_time":e.format="time";break;case"length":"array"===e.type?(e.minItems=t.requirement,e.maxItems=t.requirement):("string"!==e.type&&(a=addError(a,`The "${t.type}" action is not supported on type "${e.type}".`)),e.minLength=t.requirement,e.maxLength=t.requirement);break;case"max_entries":e.maxProperties=t.requirement;break;case"max_length":"array"===e.type?e.maxItems=t.requirement:("string"!==e.type&&(a=addError(a,`The "${t.type}" action is not supported on type "${e.type}".`)),e.maxLength=t.requirement);break;case"max_value":"number"!==e.type&&(a=addError(a,`The "max_value" action is not supported on type "${e.type}".`)),e.maximum=t.requirement;break;case"metadata":"string"==typeof t.metadata.title&&(e.title=t.metadata.title),"string"==typeof t.metadata.description&&(e.description=t.metadata.description),Array.isArray(t.metadata.examples)&&(e.examples=t.metadata.examples);break;case"min_entries":e.minProperties=t.requirement;break;case"min_length":"array"===e.type?e.minItems=t.requirement:("string"!==e.type&&(a=addError(a,`The "${t.type}" action is not supported on type "${e.type}".`)),e.minLength=t.requirement);break;case"min_value":"number"!==e.type&&(a=addError(a,`The "min_value" action is not supported on type "${e.type}".`)),e.minimum=t.requirement;break;case"multiple_of":e.multipleOf=t.requirement;break;case"non_empty":"array"===e.type?e.minItems=1:("string"!==e.type&&(a=addError(a,`The "${t.type}" action is not supported on type "${e.type}".`)),e.minLength=1);break;case"regex":t.requirement.flags&&(a=addError(a,"RegExp flags are not supported by JSON Schema.")),e.pattern=t.requirement.source;break;case"title":e.title=t.title;break;case"url":e.format="uri";break;case"uuid":e.format="uuid";break;case"value":e.const=t.requirement;break;default:a=addError(a,`The "${t.type}" action cannot be converted to JSON Schema.`)}if(r?.overrideAction){const n=r.overrideAction({valibotAction:t,jsonSchema:e,errors:a});if(n)return{...n}}if(a)for(const e of a)handleError(e,r);return e}function flattenPipe(e){return e.flatMap(e=>"pipe"in e?flattenPipe(e.pipe):e)}let e,t=0;function convertSchema(e,r,a,n,o=!1){if(!o){const t=n.referenceMap.get(r);if(t){if(e.$ref="#/$defs/"+t,a?.overrideRef){const o=a.overrideRef({...n,referenceId:t,valibotSchema:r,jsonSchema:e});o&&(e.$ref=o)}return e}}if("pipe"in r){const t=flattenPipe(r.pipe);let o=0,i=t.length-1;if("input"===a?.typeMode){const e=t.slice(1).findIndex(e=>"schema"===e.kind||"transformation"===e.kind&&("find_item"===e.type||"parse_json"===e.type||"raw_transform"===e.type||"reduce_items"===e.type||"stringify_json"===e.type||"transform"===e.type));-1!==e&&(i=e)}else if("output"===a?.typeMode){const e=t.findLastIndex(e=>"schema"===e.kind);-1!==e&&(o=e)}for(let r=o;r<=i;r++){const i=t[r];"schema"===i.kind?(r>o&&handleError('Set the "typeMode" config to "input" or "output" to convert pipelines with multiple schemas.',a),e=convertSchema(e,i,a,n,!0)):e=convertAction(e,i,a)}return e}let i;switch(r.type){case"boolean":e.type="boolean";break;case"null":e.type="null";break;case"number":e.type="number";break;case"string":e.type="string";break;case"array":e.type="array",e.items=convertSchema({},r.item,a,n);break;case"tuple":case"tuple_with_rest":case"loose_tuple":case"strict_tuple":e.type="array",e.items=[],e.minItems=r.items.length;for(const t of r.items)e.items.push(convertSchema({},t,a,n));"tuple_with_rest"===r.type?e.additionalItems=convertSchema({},r.rest,a,n):"strict_tuple"===r.type&&(e.additionalItems=!1);break;case"object":case"object_with_rest":case"loose_object":case"strict_object":e.type="object",e.properties={},e.required=[];for(const t in r.entries){const o=r.entries[t];e.properties[t]=convertSchema({},o,a,n),"nullish"!==o.type&&"optional"!==o.type&&e.required.push(t)}"object_with_rest"===r.type?e.additionalProperties=convertSchema({},r.rest,a,n):"strict_object"===r.type&&(e.additionalProperties=!1);break;case"record":"pipe"in r.key&&(i=addError(i,'The "record" schema with a schema for the key that contains a "pipe" cannot be converted to JSON Schema.')),"string"!==r.key.type&&(i=addError(i,`The "record" schema with the "${r.key.type}" schema for the key cannot be converted to JSON Schema.`)),e.type="object",e.additionalProperties=convertSchema({},r.value,a,n);break;case"any":case"unknown":break;case"nullable":case"nullish":e.anyOf=[convertSchema({},r.wrapped,a,n),{type:"null"}],void 0!==r.default&&(e.default=getDefault(r));break;case"exact_optional":case"optional":case"undefinedable":e=convertSchema(e,r.wrapped,a,n),void 0!==r.default&&(e.default=getDefault(r));break;case"literal":"boolean"!=typeof r.literal&&"number"!=typeof r.literal&&"string"!=typeof r.literal&&(i=addError(i,'The value of the "literal" schema is not JSON compatible.')),e.const=r.literal;break;case"enum":e.enum=r.options;break;case"picklist":r.options.some(e=>"number"!=typeof e&&"string"!=typeof e)&&(i=addError(i,'An option of the "picklist" schema is not JSON compatible.')),e.enum=r.options;break;case"union":case"variant":e.anyOf=r.options.map(e=>convertSchema({},e,a,n));break;case"intersect":e.allOf=r.options.map(e=>convertSchema({},e,a,n));break;case"lazy":{let o=n.getterMap.get(r.getter);o||(o=r.getter(void 0),n.getterMap.set(r.getter,o));let i=n.referenceMap.get(o);if(i||(i=""+t++,n.referenceMap.set(o,i),n.definitions[i]=convertSchema({},o,a,n,!0)),e.$ref="#/$defs/"+i,a?.overrideRef){const t=a.overrideRef({...n,referenceId:i,valibotSchema:o,jsonSchema:e});t&&(e.$ref=t)}break}default:i=addError(i,`The "${r.type}" schema cannot be converted to JSON Schema.`)}if(a?.overrideSchema){const t=a.overrideSchema({...n,referenceId:n.referenceMap.get(r),valibotSchema:r,jsonSchema:e,errors:i});if(t)return{...t}}if(i)for(const e of i)handleError(e,a);return e}function addGlobalDefs(t){e={...e??{},...t}}function getGlobalDefs(){return e}function toJsonSchema(e,t){const r={definitions:{},referenceMap:new Map,getterMap:new Map},a=t?.definitions??getGlobalDefs();if(a){for(const e in a)r.referenceMap.set(a[e],e);for(const e in a)r.definitions[e]=convertSchema({},a[e],t,r,!0)}const n=convertSchema({$schema:"http://json-schema.org/draft-07/schema#"},e,t,r);return r.referenceMap.size&&(n.$defs=r.definitions),n}function toJsonSchemaDefs(e,t){const r={definitions:{},referenceMap:new Map,getterMap:new Map};for(const t in e)r.referenceMap.set(e[t],t);for(const a in e)r.definitions[a]=convertSchema({},e[a],t,r,!0);return r.definitions}export{addGlobalDefs,getGlobalDefs,toJsonSchema,toJsonSchemaDefs};
